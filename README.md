# Бот для технической поддержки KFC
Предназначен для упрощения работы тех поддержки.  
Управление ключевыми параметрами работы бота осуществляется через админ-панель.

## Бот умеет:
- Запускать синхронизацию по ресторанам, как точечно, так и массово.
- Запускать синхронизация по транзитным серверам.
- Формировать отчет по результату синхронизации.
- Сканировать почту для поиска информации по задачам.
- Выводить краткое и полное описание задачи.
- Сообщать о задачах с критическим приоритетом.
- Осуществлять контроль доступа к функциям бота.

## Требования:
- Python >= 3.11
- Установленный переменные окружения

## Доступные переменные окружения:
1. Переменные окружения приложения (файл `.env`):
   - Обязательные
     ```dotenv
     SERET_KEY: str - уникальный секретный ключь приложения. Сгенерировать можно здесь  => https://djecrety.ir/.
	    TG_BOT_TOKEN: str - токен телеграм бота. Получить можно тут https://t.me/BotFather
	    TG_BOT_ADMIN: int - телеграм id главного администратора бота.
	
	    # для работы с xml интерфейсом
	    XML_LOGIN: str - логин для xml интерфейсов серверов R-Keeper.
	    XML_PASSWORD: str - пароль для xml интерфейсов серверов R-Keeper.
	
	    # настройки почты.
	    MAIL_LOGIN: str - логин от почтового ящика с письмами GSD.
	    MAIL_PASSWORD: str - пароль от почтового ящика с письмами GSD.
	    MAIL_IMAP_SERVER: str -  почтовый сервер IMAP. 
     ```
   - Опциональные
     ```dotenv
     DB_URL: str - строка подключения для базы приложения. Значение по умолчанию: sqlite:///db.sqlite3.
     ALLOWED_HOSTS: list - список доверительных узлов.Значение по умолчанию: '127.0.0.1','localhost'.
     DEBUG: bool - отладочный режим. Значение по умолчанию: False.
     CSRF_TRUSTED_ORIGINS: list - Список доверенных источников небезопасных запросов (например, POST). Значение по умолчанию: 'http://localhost:1337'
	    TASK_ESCALATION: int -  время первой  и второй эскалации для задач в минутах. Значение по умолчанию 10.
     TASK_DEADLINE: int - время dedline для задачи в минутах. Значение умолчанию 120.  
     SYNC_TIMEOUT: int - Таймауты синхронизации в секундах. Значение по умолчанию: 7.
     # настройка статики
     STATIC_URL: str - url префикс для статики приложения. Значение по умолчанию /static/.
     STATIC_ROOT: str - путь для хранения статики на сервере. Значение по умолчанию: папка static в корне проекта.
    
     # Rollbar
     ROLLBAR_ACCESS_TOKEN: str - токен проекта внутри Rollbar. Значение по умолчанию не задано.
     ROLLBAR_ENV: str - окружение проекта Rollbar(dev/production). Занчение по умолчанию: dev.
     
     # Redis (используется для хранения задач шедулера. По умолчанию хранит в памяти)
     REDIS_HOST: str - Хост redis сервера. Значение по умолчанию: '' при использовании Docker использовать значение 'redis'
     REDIS_PORT: int - Порт соединия redis. Значение по умолчанию: 6379
     ```
2. Для настройки БД в Docker(файл `.env.db`):
   ```dotenv
    POSTGRES_USER: str - имя пользователя БД.
    POSTGRES_PASSWORD: str - пароль БД.
    POSTGRES_NAME: str - имя БД.
    ```
   
## Менеджмент команды приложения:
Запуск телеграм бота:
```shell
python manage.py start_tg_bot
```
Загрузка команд бота(Требуется файл `support_bot_commands.json` в папке `config`):
```shell
python manage.py upload_bot_commands
```
Пример файла с командами (`support_bot_commands.json`):
```json
[
  {
    "command": "/on_shift",
	"description": "Заступить на смену(получать задачи)",
	"privilege_groups": ["Администраторы", "Старшие инженеры", "Ведущие инженеры", "Инженеры"]
  },
  {
    "command": "/end_shift",
    "description": "Закончить смену",
    "privilege_groups": ["Администраторы", "Старшие инженеры", "Ведущие инженеры", "Инженеры"]
  }
]
```
Загрузка информации по ресторанам:
```shell
python manage.py upload_restaurants
```
Загрузка информации по транзитам:
```shell
python manage.py upload_transits
```
Загрузка задач из почты:
```shell
python manage.py upload_task
```
